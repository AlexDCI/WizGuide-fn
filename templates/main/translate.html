{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/translate.css' %}">
<style>
  /* –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –ø–æ–ª—è */
  .text-area-small   { min-height:160px; resize: vertical; }
  .comment-area-small{ min-height:100px; resize: vertical; }

  /* –±–ª–æ–∫ –≥–æ–ª–æ—Å–∞ */
  .voice-card{ background:#f8f9fa; border-radius:12px; padding:16px; margin-top:22px; }
  .mic-wrap{ position:relative; display:flex; flex-direction:column; align-items:center; gap:8px; }
  .mic-btn{
    width:68px; height:68px; border-radius:50%; font-size:28px; line-height:1;
    display:flex; align-items:center; justify-content:center;
    border:none; color:#fff; background:#0d6efd; cursor:pointer;
    box-shadow:0 6px 18px rgba(13,110,253,.35);
    user-select:none;
  }
  .mic-btn:disabled{ opacity:.6; cursor:not-allowed }

  /* –∫–∞–Ω–≤–∞ –¥–ª—è ¬´–≤–æ–ª–Ω –≤–æ–∫—Ä—É–≥ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞¬ª */
  #micWaves{ position:absolute; inset:-12px 0 auto 0; width:120px; height:120px; pointer-events:none; }

  /* –≤—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
  .voice-out{ white-space:pre-wrap; background:#fff; border:1px solid #e6e6e6; border-radius:8px; padding:10px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid d-flex justify-content-center p-0">
  <div class="form-container">
    <h1>{{ translations.title }}</h1>
    {% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}

    <!-- —Ñ–æ—Ä–º–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞ -->
    <form method="post">
      {% csrf_token %}

      <label for="text">{{ translations.text_label }}:</label>
      <textarea name="text" id="text" class="form-control mb-3 text-area-small" maxlength="1000"></textarea>

      <div class="d-flex align-items-center mb-3">
        <select name="source_lang" id="source_lang" class="form-select">
          <option value="" disabled {% if not source_lang %}selected{% endif %}>–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</option>
          {% for lang in languages %}
            <option value="{{ lang }}" {% if source_lang == lang %}selected{% endif %}>{{ lang }}</option>
          {% endfor %}
        </select>

        <button type="button" id="swap-languages" class="btn btn-secondary mx-2">‚Üî</button>

        <select name="target_lang" id="target_lang" class="form-select">
          <option value="" disabled {% if not target_lang %}selected{% endif %}>–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</option>
          {% for lang in languages %}
            <option value="{{ lang }}" {% if target_lang == lang %}selected{% endif %}>{{ lang }}</option>
          {% endfor %}
        </select>
      </div>

      <label for="comment_request">{{ translations.comment_request_label }}:</label>
      <textarea name="comment_request" id="comment_request" class="form-control mb-3 comment-area-small"
        placeholder="{{ translations.optional }}" maxlength="1000"></textarea>

      <button type="submit" class="btn btn-primary w-100">{{ translations.translate_btn }}</button>
    </form>

    <!-- üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π –ø–µ—Ä–µ–≤–æ–¥ ‚Äî —Ç–µ–ø–µ—Ä—å —Å—Ä–∞–∑—É –ø–æ–¥ –ø–æ–ª—è–º–∏ -->
    <div class="voice-card">
      <h5 class="mb-2">üé§ –ì–æ–ª–æ—Å–æ–≤–æ–π –ø–µ—Ä–µ–≤–æ–¥</h5>

      <div class="mic-wrap">
        <canvas id="micWaves" width="120" height="120"></canvas>
        <button id="micBtn" class="mic-btn" title="–ó–∞–∂–º–∏—Ç–µ, –≥–æ–≤–æ—Ä–∏—Ç–µ, –æ—Ç–ø—É—Å—Ç–∏—Ç–µ">üé§</button>
        <div id="v_status" class="small text-muted">–ì–æ—Ç–æ–≤–æ</div>
      </div>

      <div class="mt-2 voice-out" id="v_src"><b>üìù –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</b>\n‚Äî</div>
      <div class="mt-2 voice-out" id="v_trg"><b>üåç –ü–µ—Ä–µ–≤–æ–¥:</b>\n‚Äî</div>
    </div>

    <!-- –∏—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    {% if chat_history %}
<div class="chat-history mt-4 p-3 bg-light rounded">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h3 class="m-0">{{ translations.history_label }}</h3>
    <form method="post" action="{% url 'clear_chat' %}">
      {% csrf_token %}
      <button type="submit" class="btn btn-sm btn-danger">Clear Chat</button>
    </form>
  </div>

  <ul class="list-group">
    {% for chat in chat_history %}
      <li class="list-group-item">
        <strong>{{ chat.input_text }}</strong> ‚Üí <em>{{ chat.translated_text }}</em>
        {% if chat.comment %}
          <br><small>{{ translations.explanation_label }}: {{ chat.comment }}</small>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
</div>
{% else %}
<!-- –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ—Ç ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∂–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
<div class="mt-4">
  <form method="post" action="{% url 'clear_chat' %}">
    {% csrf_token %}
    <button type="submit" class="btn btn-sm btn-danger">Clear Chat</button>
  </form>
</div>
{% endif %}

  </div>
</div>

<!-- –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π JS –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–π —Ñ–æ—Ä–º—ã -->
<script src="{% static 'js/translate.js' %}"></script>
<!-- –Ω–æ–≤—ã–π JS –¥–ª—è –≥–æ–ª–æ—Å–∞ (press-and-hold + –≤–æ–ª–Ω—ã) -->
<script src="{% static 'js/voice.js' %}?v=6"></script>
{% endblock %}
